<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PVF Host and Workers - The Polkadot Parachain Host Implementers&#x27; Guide</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../last-changed.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Preamble</a></li><li class="chapter-item expanded "><a href="../../whence-parachains.html"><strong aria-hidden="true">1.</strong> Whence Parachains</a></li><li class="chapter-item expanded "><a href="../../protocol-overview.html"><strong aria-hidden="true">2.</strong> Protocol Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../protocol-approval.html"><strong aria-hidden="true">2.1.</strong> Approval Process</a></li><li class="chapter-item expanded "><a href="../../protocol-disputes.html"><strong aria-hidden="true">2.2.</strong> Disputes Process</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../disputes-flow.html"><strong aria-hidden="true">2.2.1.</strong> Dispute Flow</a></li></ol></li><li class="chapter-item expanded "><a href="../../protocol-chain-selection.html"><strong aria-hidden="true">2.3.</strong> Chain Selection and Finalization</a></li></ol></li><li class="chapter-item expanded "><a href="../../architecture.html"><strong aria-hidden="true">3.</strong> Architecture Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../messaging.html"><strong aria-hidden="true">3.1.</strong> Messaging Overview</a></li><li class="chapter-item expanded "><a href="../../pvf-prechecking.html"><strong aria-hidden="true">3.2.</strong> PVF Pre-checking</a></li></ol></li><li class="chapter-item expanded "><a href="../../runtime/index.html"><strong aria-hidden="true">4.</strong> Runtime Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../runtime/initializer.html"><strong aria-hidden="true">4.1.</strong> Initializer Pallet</a></li><li class="chapter-item expanded "><a href="../../runtime/configuration.html"><strong aria-hidden="true">4.2.</strong> Configuration Pallet</a></li><li class="chapter-item expanded "><a href="../../runtime/shared.html"><strong aria-hidden="true">4.3.</strong> Shared Pallet</a></li><li class="chapter-item expanded "><a href="../../runtime/disputes.html"><strong aria-hidden="true">4.4.</strong> Disputes Pallet</a></li><li class="chapter-item expanded "><a href="../../runtime/paras.html"><strong aria-hidden="true">4.5.</strong> Paras Pallet</a></li><li class="chapter-item expanded "><a href="../../runtime/scheduler.html"><strong aria-hidden="true">4.6.</strong> Scheduler Pallet</a></li><li class="chapter-item expanded "><a href="../../runtime/inclusion.html"><strong aria-hidden="true">4.7.</strong> Inclusion Pallet</a></li><li class="chapter-item expanded "><a href="../../runtime/parainherent.html"><strong aria-hidden="true">4.8.</strong> ParaInherent Pallet</a></li><li class="chapter-item expanded "><a href="../../runtime/dmp.html"><strong aria-hidden="true">4.9.</strong> DMP Pallet</a></li><li class="chapter-item expanded "><a href="../../runtime/hrmp.html"><strong aria-hidden="true">4.10.</strong> HRMP Pallet</a></li><li class="chapter-item expanded "><a href="../../runtime/session_info.html"><strong aria-hidden="true">4.11.</strong> Session Info Pallet</a></li></ol></li><li class="chapter-item expanded "><a href="../../runtime-api/index.html"><strong aria-hidden="true">5.</strong> Runtime APIs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../runtime-api/validators.html"><strong aria-hidden="true">5.1.</strong> Validators</a></li><li class="chapter-item expanded "><a href="../../runtime-api/validator-groups.html"><strong aria-hidden="true">5.2.</strong> Validator Groups</a></li><li class="chapter-item expanded "><a href="../../runtime-api/availability-cores.html"><strong aria-hidden="true">5.3.</strong> Availability Cores</a></li><li class="chapter-item expanded "><a href="../../runtime-api/persisted-validation-data.html"><strong aria-hidden="true">5.4.</strong> Persisted Validation Data</a></li><li class="chapter-item expanded "><a href="../../runtime-api/session-index.html"><strong aria-hidden="true">5.5.</strong> Session Index</a></li><li class="chapter-item expanded "><a href="../../runtime-api/validation-code.html"><strong aria-hidden="true">5.6.</strong> Validation Code</a></li><li class="chapter-item expanded "><a href="../../runtime-api/candidate-pending-availability.html"><strong aria-hidden="true">5.7.</strong> Candidate Pending Availability</a></li><li class="chapter-item expanded "><a href="../../runtime-api/candidate-events.html"><strong aria-hidden="true">5.8.</strong> Candidate Events</a></li><li class="chapter-item expanded "><a href="../../runtime-api/disputes-info.html"><strong aria-hidden="true">5.9.</strong> Disputes Info</a></li><li class="chapter-item expanded "><a href="../../runtime-api/candidates-included.html"><strong aria-hidden="true">5.10.</strong> Candidates Included</a></li><li class="chapter-item expanded "><a href="../../runtime-api/pvf-prechecking.html"><strong aria-hidden="true">5.11.</strong> PVF Pre-checking</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/index.html"><strong aria-hidden="true">6.</strong> Node Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/subsystems-and-jobs.html"><strong aria-hidden="true">6.1.</strong> Subsystems and Jobs</a></li><li class="chapter-item expanded "><a href="../../node/overseer.html"><strong aria-hidden="true">6.2.</strong> Overseer</a></li><li class="chapter-item expanded "><a href="../../node/grandpa-voting-rule.html"><strong aria-hidden="true">6.3.</strong> GRANDPA Voting Rule</a></li><li class="chapter-item expanded "><a href="../../node/collators/index.html"><strong aria-hidden="true">6.4.</strong> Collator Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/collators/collation-generation.html"><strong aria-hidden="true">6.4.1.</strong> Collation Generation</a></li><li class="chapter-item expanded "><a href="../../node/collators/collator-protocol.html"><strong aria-hidden="true">6.4.2.</strong> Collator Protocol</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/backing/index.html"><strong aria-hidden="true">6.5.</strong> Backing Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/backing/candidate-backing.html"><strong aria-hidden="true">6.5.1.</strong> Candidate Backing</a></li><li class="chapter-item expanded "><a href="../../node/backing/prospective-parachains.html"><strong aria-hidden="true">6.5.2.</strong> Prospective Parachains</a></li><li class="chapter-item expanded "><a href="../../node/backing/statement-distribution.html"><strong aria-hidden="true">6.5.3.</strong> Statement Distribution</a></li><li class="chapter-item expanded "><a href="../../node/backing/statement-distribution-legacy.html"><strong aria-hidden="true">6.5.4.</strong> Statement Distribution (Legacy)</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/availability/index.html"><strong aria-hidden="true">6.6.</strong> Availability Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/availability/availability-distribution.html"><strong aria-hidden="true">6.6.1.</strong> Availability Distribution</a></li><li class="chapter-item expanded "><a href="../../node/availability/availability-recovery.html"><strong aria-hidden="true">6.6.2.</strong> Availability Recovery</a></li><li class="chapter-item expanded "><a href="../../node/availability/bitfield-distribution.html"><strong aria-hidden="true">6.6.3.</strong> Bitfield Distribution</a></li><li class="chapter-item expanded "><a href="../../node/availability/bitfield-signing.html"><strong aria-hidden="true">6.6.4.</strong> Bitfield Signing</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/approval/index.html"><strong aria-hidden="true">6.7.</strong> Approval Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/approval/approval-voting.html"><strong aria-hidden="true">6.7.1.</strong> Approval Voting</a></li><li class="chapter-item expanded "><a href="../../node/approval/approval-distribution.html"><strong aria-hidden="true">6.7.2.</strong> Approval Distribution</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/disputes/index.html"><strong aria-hidden="true">6.8.</strong> Disputes Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/disputes/dispute-coordinator.html"><strong aria-hidden="true">6.8.1.</strong> Dispute Coordinator</a></li><li class="chapter-item expanded "><a href="../../node/disputes/dispute-distribution.html"><strong aria-hidden="true">6.8.2.</strong> Dispute Distribution</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/utility/index.html"><strong aria-hidden="true">6.9.</strong> Utility Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/utility/availability-store.html"><strong aria-hidden="true">6.9.1.</strong> Availability Store</a></li><li class="chapter-item expanded "><a href="../../node/utility/candidate-validation.html"><strong aria-hidden="true">6.9.2.</strong> Candidate Validation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/utility/pvf-host-and-workers.html" class="active"><strong aria-hidden="true">6.9.2.1.</strong> PVF Host and Workers</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/utility/provisioner.html"><strong aria-hidden="true">6.9.3.</strong> Provisioner</a></li><li class="chapter-item expanded "><a href="../../node/utility/network-bridge.html"><strong aria-hidden="true">6.9.4.</strong> Network Bridge</a></li><li class="chapter-item expanded "><a href="../../node/utility/gossip-support.html"><strong aria-hidden="true">6.9.5.</strong> Gossip Support</a></li><li class="chapter-item expanded "><a href="../../node/utility/peer-set-manager.html"><strong aria-hidden="true">6.9.6.</strong> Peer Set Manager</a></li><li class="chapter-item expanded "><a href="../../node/utility/runtime-api.html"><strong aria-hidden="true">6.9.7.</strong> Runtime API Requests</a></li><li class="chapter-item expanded "><a href="../../node/utility/chain-api.html"><strong aria-hidden="true">6.9.8.</strong> Chain API Requests</a></li><li class="chapter-item expanded "><a href="../../node/utility/chain-selection.html"><strong aria-hidden="true">6.9.9.</strong> Chain Selection Request</a></li><li class="chapter-item expanded "><a href="../../node/utility/pvf-prechecker.html"><strong aria-hidden="true">6.9.10.</strong> PVF Pre-Checking</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../types/index.html"><strong aria-hidden="true">7.</strong> Data Structures and Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../types/candidate.html"><strong aria-hidden="true">7.1.</strong> Candidate</a></li><li class="chapter-item expanded "><a href="../../types/backing.html"><strong aria-hidden="true">7.2.</strong> Backing</a></li><li class="chapter-item expanded "><a href="../../types/availability.html"><strong aria-hidden="true">7.3.</strong> Availability</a></li><li class="chapter-item expanded "><a href="../../types/overseer-protocol.html"><strong aria-hidden="true">7.4.</strong> Overseer and Subsystem Protocol</a></li><li class="chapter-item expanded "><a href="../../types/runtime.html"><strong aria-hidden="true">7.5.</strong> Runtime</a></li><li class="chapter-item expanded "><a href="../../types/messages.html"><strong aria-hidden="true">7.6.</strong> Messages</a></li><li class="chapter-item expanded "><a href="../../types/network.html"><strong aria-hidden="true">7.7.</strong> Network</a></li><li class="chapter-item expanded "><a href="../../types/approval.html"><strong aria-hidden="true">7.8.</strong> Approvals</a></li><li class="chapter-item expanded "><a href="../../types/disputes.html"><strong aria-hidden="true">7.9.</strong> Disputes</a></li><li class="chapter-item expanded "><a href="../../types/pvf-prechecking.html"><strong aria-hidden="true">7.10.</strong> PVF Pre-checking</a></li></ol></li><li class="chapter-item expanded "><a href="../../glossary.html">Glossary</a></li><li class="chapter-item expanded affix "><a href="../../further-reading.html">Further Reading</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Polkadot Parachain Host Implementers&#x27; Guide</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/paritytech/polkadot-sdk" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="pvf-host-and-workers"><a class="header" href="#pvf-host-and-workers">PVF Host and Workers</a></h1>
<p>The PVF host is responsible for handling requests to prepare and execute PVF
code blobs, which it sends to PVF <strong>workers</strong> running in their own child
processes. These workers are spawned from the <code>polkadot-prepare-worker</code> and
<code>polkadot-execute-worker</code> binaries.</p>
<p>While the workers are generally long-living, they also spawn one-off secure
<strong>job processes</strong> that perform the jobs. See &quot;Job Processes&quot; section below.</p>
<h2 id="high-level-flow"><a class="header" href="#high-level-flow">High-Level Flow</a></h2>
<div><!-- Generated by graphviz version 2.43.0 (0)
 --><!-- Title: %3 Pages: 1 --><svg width="1008pt" height="494pt"
 viewBox="0.00 0.00 1008.00 494.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 490)"><title>%3</title><polygon fill="white" stroke="transparent" points="-4,4 -4,-490 1004,-490 1004,4 -4,4"/><g id="clust1" class="cluster"><title>cluster partial_sandbox_prep</title><polygon fill="none" stroke="black" points="642,-247 642,-478 1000,-478 1000,-247 642,-247"/><text text-anchor="middle" x="821" y="-462.8" font-family="Times,serif" font-size="14.00">polkadot&#45;prepare&#45;worker</text><text text-anchor="middle" x="821" y="-447.8" font-family="Times,serif" font-size="14.00">(Partial Sandbox)</text></g><g id="clust2" class="cluster"><title>cluster full_sandbox_prep</title><polygon fill="none" stroke="black" points="812,-255 812,-400 992,-400 992,-255 812,-255"/><text text-anchor="middle" x="902" y="-384.8" font-family="Times,serif" font-size="14.00">Fully Isolated Sandbox</text></g><g id="clust3" class="cluster"><title>cluster partial_sandbox_exec</title><polygon fill="none" stroke="black" points="478,-8 478,-239 785,-239 785,-8 478,-8"/><text text-anchor="middle" x="631.5" y="-223.8" font-family="Times,serif" font-size="14.00">polkadot&#45;execute&#45;worker</text><text text-anchor="middle" x="631.5" y="-208.8" font-family="Times,serif" font-size="14.00">(Partial Sandbox)</text></g><g id="clust4" class="cluster"><title>cluster full_sandbox_exec</title><polygon fill="none" stroke="black" points="597,-16 597,-161 777,-161 777,-16 597,-16"/><text text-anchor="middle" x="687" y="-145.8" font-family="Times,serif" font-size="14.00">Fully Isolated Sandbox</text></g><!-- can --><g id="node1" class="node"><title>can</title><polygon fill="none" stroke="black" points="95,-269.5 0,-269.5 0,-174.5 95,-174.5 95,-269.5"/><text text-anchor="middle" x="47.5" y="-233.3" font-family="Times,serif" font-size="14.00">Candidate</text><text text-anchor="middle" x="47.5" y="-218.3" font-family="Times,serif" font-size="14.00">Validation</text><text text-anchor="middle" x="47.5" y="-203.3" font-family="Times,serif" font-size="14.00">Subsystem</text></g><!-- pvf --><g id="node2" class="node"><title>pvf</title><polygon fill="none" stroke="black" points="281,-264 197,-264 197,-180 281,-180 281,-264"/><text text-anchor="middle" x="239" y="-218.3" font-family="Times,serif" font-size="14.00">PVF Host</text></g><!-- can&#45;&gt;pvf --><g id="edge1" class="edge"><title>can&#45;&gt;pvf</title><path fill="none" stroke="black" stroke-dasharray="5,2" d="M95.34,-222C123.07,-222 158.21,-222 186.68,-222"/><polygon fill="black" stroke="black" points="186.84,-225.5 196.84,-222 186.84,-218.5 186.84,-225.5"/><text text-anchor="middle" x="146" y="-225.8" font-family="Times,serif" font-size="14.00">Precheck</text></g><!-- can&#45;&gt;pvf --><g id="edge2" class="edge"><title>can&#45;&gt;pvf</title><path fill="none" stroke="black" d="M95,-206.6C101,-205.12 107.11,-203.85 113,-203 142.03,-198.81 150.02,-198.45 179,-203 181.65,-203.42 184.34,-203.93 187.04,-204.52"/><polygon fill="black" stroke="black" points="186.26,-207.93 196.81,-206.95 187.95,-201.14 186.26,-207.93"/><text text-anchor="middle" x="146" y="-206.8" font-family="Times,serif" font-size="14.00">Validate</text></g><!-- pvf&#45;&gt;pvf --><g id="edge5" class="edge"><title>pvf&#45;&gt;pvf</title><path fill="none" stroke="black" stroke-dasharray="5,2" d="M222.76,-264.06C223.96,-274.34 229.38,-282 239,-282 245.17,-282 249.6,-278.86 252.31,-273.89"/><polygon fill="black" stroke="black" points="255.74,-274.64 255.24,-264.06 249.03,-272.64 255.74,-274.64"/><text text-anchor="middle" x="239" y="-285.8" font-family="Times,serif" font-size="14.00">see (2) and (3)</text></g><!-- pq --><g id="node3" class="node"><title>pq</title><polygon fill="none" stroke="black" points="449,-318 375,-318 375,-244 449,-244 449,-318"/><text text-anchor="middle" x="412" y="-284.8" font-family="Times,serif" font-size="14.00">Prepare</text><text text-anchor="middle" x="412" y="-269.8" font-family="Times,serif" font-size="14.00">Queue</text></g><!-- pvf&#45;&gt;pq --><g id="edge3" class="edge"><title>pvf&#45;&gt;pq</title><path fill="none" stroke="black" stroke-dasharray="5,2" d="M281.39,-236.28C306.72,-245.02 339.17,-256.22 365.26,-265.22"/><polygon fill="black" stroke="black" points="364.32,-268.6 374.91,-268.55 366.6,-261.98 364.32,-268.6"/><text text-anchor="middle" x="328" y="-264.8" font-family="Times,serif" font-size="14.00">Prepare</text></g><!-- eq --><g id="node4" class="node"><title>eq</title><polygon fill="none" stroke="black" points="449,-213 375,-213 375,-139 449,-139 449,-213"/><text text-anchor="middle" x="412" y="-179.8" font-family="Times,serif" font-size="14.00">Execute</text><text text-anchor="middle" x="412" y="-164.8" font-family="Times,serif" font-size="14.00">Queue</text></g><!-- pvf&#45;&gt;eq --><g id="edge4" class="edge"><title>pvf&#45;&gt;eq</title><path fill="none" stroke="black" d="M281.39,-210.86C306.72,-204.05 339.17,-195.32 365.26,-188.31"/><polygon fill="black" stroke="black" points="366.17,-191.68 374.91,-185.71 364.35,-184.93 366.17,-191.68"/><text text-anchor="middle" x="328" y="-208.8" font-family="Times,serif" font-size="14.00">Execute</text></g><!-- pp --><g id="node5" class="node"><title>pp</title><polygon fill="none" stroke="black" points="560,-325 486,-325 486,-251 560,-251 560,-325"/><text text-anchor="middle" x="523" y="-291.8" font-family="Times,serif" font-size="14.00">Prepare</text><text text-anchor="middle" x="523" y="-276.8" font-family="Times,serif" font-size="14.00">Pool</text></g><!-- pq&#45;&gt;pp --><g id="edge6" class="edge"><title>pq&#45;&gt;pp</title><path fill="none" stroke="black" stroke-dasharray="5,2" d="M449.3,-283.33C457.75,-283.87 466.87,-284.46 475.7,-285.03"/><polygon fill="black" stroke="black" points="475.66,-288.53 485.86,-285.68 476.11,-281.55 475.66,-288.53"/></g><!-- ew --><g id="node8" class="node"><title>ew</title><polygon fill="none" stroke="black" points="560,-135 486,-135 486,-61 560,-61 560,-135"/><text text-anchor="middle" x="523" y="-101.8" font-family="Times,serif" font-size="14.00">Execute</text><text text-anchor="middle" x="523" y="-86.8" font-family="Times,serif" font-size="14.00">Worker</text></g><!-- eq&#45;&gt;ew --><g id="edge8" class="edge"><title>eq&#45;&gt;ew</title><path fill="none" stroke="black" d="M449.3,-150.03C458.4,-143.51 468.26,-136.45 477.7,-129.7"/><polygon fill="black" stroke="black" points="479.77,-132.53 485.86,-123.86 475.69,-126.83 479.77,-132.53"/></g><!-- pw --><g id="node6" class="node"><title>pw</title><polygon fill="none" stroke="black" points="724,-333 650,-333 650,-259 724,-259 724,-333"/><text text-anchor="middle" x="687" y="-299.8" font-family="Times,serif" font-size="14.00">Prepare</text><text text-anchor="middle" x="687" y="-284.8" font-family="Times,serif" font-size="14.00">Worker</text></g><!-- pp&#45;&gt;pw --><g id="edge7" class="edge"><title>pp&#45;&gt;pw</title><path fill="none" stroke="black" stroke-dasharray="5,2" d="M560.36,-289.8C583.81,-290.95 614.51,-292.47 639.7,-293.71"/><polygon fill="black" stroke="black" points="639.6,-297.21 649.77,-294.21 639.95,-290.22 639.6,-297.21"/></g><!-- pj --><g id="node7" class="node"><title>pj</title><polygon fill="none" stroke="black" points="939,-337 865,-337 865,-263 939,-263 939,-337"/><text text-anchor="middle" x="902" y="-303.8" font-family="Times,serif" font-size="14.00">Prepare</text><text text-anchor="middle" x="902" y="-288.8" font-family="Times,serif" font-size="14.00">Job</text></g><!-- pw&#45;&gt;pj --><g id="edge9" class="edge"><title>pw&#45;&gt;pj</title><path fill="none" stroke="black" stroke-dasharray="5,2" d="M724.13,-296.68C760.09,-297.35 815.41,-298.39 854.6,-299.13"/><polygon fill="black" stroke="black" points="854.63,-302.63 864.69,-299.32 854.76,-295.63 854.63,-302.63"/></g><!-- ej --><g id="node9" class="node"><title>ej</title><polygon fill="none" stroke="black" points="724,-98 650,-98 650,-24 724,-24 724,-98"/><text text-anchor="middle" x="687" y="-64.8" font-family="Times,serif" font-size="14.00">Execute</text><text text-anchor="middle" x="687" y="-49.8" font-family="Times,serif" font-size="14.00">Job</text></g><!-- ew&#45;&gt;ej --><g id="edge10" class="edge"><title>ew&#45;&gt;ej</title><path fill="none" stroke="black" d="M560.36,-89.7C583.81,-84.34 614.51,-77.33 639.7,-71.57"/><polygon fill="black" stroke="black" points="640.8,-74.91 649.77,-69.28 639.24,-68.09 640.8,-74.91"/></g></g></svg></div>
<p>Some notes about the graph:</p>
<ol>
<li>Once a job has finished, the response will flow back up the way it came.</li>
<li>In the case of execution, the host will send a request for preparation to the
Prepare Queue if needed. In that case, only after the preparation succeeds
does the Execute Queue continue with validation.</li>
<li>Multiple requests for preparing the same artifact are coalesced, so that the
work is only done once.</li>
</ol>
<h2 id="goals"><a class="header" href="#goals">Goals</a></h2>
<p>This system has two high-level goals that we will touch on here: <em>determinism</em>
and <em>security</em>.</p>
<h2 id="determinism"><a class="header" href="#determinism">Determinism</a></h2>
<p>One high-level goal is to make PVF operations as deterministic as possible, to
reduce the rate of disputes. Disputes can happen due to e.g. a job timing out on
one machine, but not another. While we do not have full determinism, there are
some dispute reduction mechanisms in place right now.</p>
<h3 id="retrying-execution-requests"><a class="header" href="#retrying-execution-requests">Retrying execution requests</a></h3>
<p>If the execution request fails during <strong>preparation</strong>, we will retry if it is
possible that the preparation error was transient (e.g. if the error was a panic
or time out). We will only retry preparation if another request comes in after
15 minutes, to ensure any potential transient conditions had time to be
resolved. We will retry up to 5 times.</p>
<p>If the actual <strong>execution</strong> of the artifact fails, we will retry once if it was
a possibly transient error, to allow the conditions that led to the error to
hopefully resolve. We use a more brief delay here (1 second as opposed to 15
minutes for preparation (see above)), because a successful execution must happen
in a short amount of time.</p>
<p>If the execution fails during the backing phase, we won't retry to reduce the chance of
supporting nondeterministic candidates. This reduces the chance of nondeterministic blocks
getting backed and honest backers getting slashed.</p>
<p>We currently know of the following specific cases that will lead to a retried
execution request:</p>
<ol>
<li><strong>OOM:</strong> We have memory limits to try to prevent attackers from exhausting
host memory. If the memory limit is hit, we kill the job process and retry
the job. Alternatively, the host might have been temporarily low on memory
due to other processes running on the same machine. <strong>NOTE:</strong> This case will
lead to voting against the candidate (and possibly a dispute) if the retry is
still not successful.</li>
<li><strong>Syscall violations:</strong> If the job attempts a system call that is blocked by
the sandbox's security policy, the job process is immediately killed and we
retry. <strong>NOTE:</strong> In the future, if we have a proper way to detect that the
job died due to a security violation, it might make sense not to retry in
this case.</li>
<li><strong>Artifact missing:</strong> The prepared artifact might have been deleted due to
operator error or some bug in the system.</li>
<li><strong>Job errors:</strong> For example, the job process panicked for some indeterminate
reason, which may or may not be independent of the candidate or PVF.</li>
<li><strong>Internal errors:</strong> See &quot;Internal Errors&quot; section. In this case, after the
retry we abstain from voting.</li>
<li><strong>RuntimeConstruction</strong> error. The precheck handles a general case of a wrong
artifact but doesn't guarantee its consistency between the preparation and
the execution. If something happened with the artifact between
the preparation of the artifact and its execution (e.g. the artifact was
corrupted on disk or a dirty node upgrade happened when the prepare worker
has a wasmtime version different from the execute worker's wasmtime version).
We treat such an error as possibly transient due to local issues and retry
one time.</li>
</ol>
<h3 id="preparation-timeouts"><a class="header" href="#preparation-timeouts">Preparation timeouts</a></h3>
<p>We use timeouts for both preparation and execution jobs to limit the amount of
time they can take. As the time for a job can vary depending on the machine and
load on the machine, this can potentially lead to disputes where some validators
successfully execute a PVF and others don't.</p>
<p>One dispute mitigation we have in place is a more lenient timeout for
preparation during execution than during pre-checking. The rationale is that the
PVF has already passed pre-checking, so we know it should be valid, and we allow
it to take longer than expected, as this is likely due to an issue with the
machine and not the PVF.</p>
<h3 id="cpu-clock-timeouts"><a class="header" href="#cpu-clock-timeouts">CPU clock timeouts</a></h3>
<p>Another timeout-related mitigation we employ is to measure the time taken by
jobs using CPU time, rather than wall clock time. This is because the CPU time
of a process is less variable under different system conditions. When the
overall system is under heavy load, the wall clock time of a job is affected
more than the CPU time.</p>
<h3 id="internal-errors"><a class="header" href="#internal-errors">Internal errors</a></h3>
<p>An internal, or local, error is one that we treat as independent of the PVF
and/or candidate, i.e. local to the running machine. If this happens, then we
will first retry the job and if the errors persists, then we simply do not vote.
This prevents slashes, since otherwise our vote may not agree with that of the
other validators.</p>
<p>In general, for errors not raising a dispute we have to be very careful. This is
only sound, if either:</p>
<ol>
<li>We ruled out that error in pre-checking. If something is not checked in
pre-checking, even if independent of the candidate and PVF, we must raise a
dispute.</li>
<li>We are 100% confident that it is a hardware/local issue: Like corrupted file,
etc.</li>
</ol>
<p>Reasoning: Otherwise it would be possible to register a PVF where candidates can
not be checked, but we don't get a dispute - so nobody gets punished. Second, we
end up with a finality stall that is not going to resolve!</p>
<p>Note that any error from the job process we cannot treat as internal. The job
runs untrusted code and an attacker can therefore return arbitrary errors. If
they were to return errors that we treat as internal, they could make us abstain
from voting. Since we are unsure if such errors are legitimate, we will first
retry the candidate, and if the issue persists we are forced to vote invalid.</p>
<h2 id="security"><a class="header" href="#security">Security</a></h2>
<p>With <a href="https://github.com/orgs/paritytech/projects/67">on-demand parachains</a>, it
is much easier to submit PVFs to the chain for preparation and execution. This
makes it easier for erroneous disputes and slashing to occur, whether
intentional (as a result of a malicious attacker) or not (a bug or operator
error occurred).</p>
<p>Therefore, another goal of ours is to harden our security around PVFs, in order
to protect the economic interests of validators and increase overall confidence
in the system.</p>
<h3 id="possible-attacks--threat-model"><a class="header" href="#possible-attacks--threat-model">Possible attacks / threat model</a></h3>
<p>Webassembly is already sandboxed, but there have already been reported multiple
CVEs enabling remote code execution. See e.g. these two advisories from
<a href="https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-ff4p-7xrq-q5r8">Mar 2023</a>
and <a href="https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-7f6x-jwh5-m9r4">Jul 2022</a>.</p>
<p>So what are we actually worried about? Things that come to mind:</p>
<ol>
<li><strong>Consensus faults</strong> - If an attacker can get some source of randomness they
could vote against with 50% chance and cause unresolvable disputes.</li>
<li><strong>Targeted slashes</strong> - An attacker can target certain validators (e.g. some
validators running on vulnerable hardware) and make them vote invalid and get
them slashed.</li>
<li><strong>Mass slashes</strong> - With some source of randomness they can do an untargeted
attack. I.e. a baddie can do significant economic damage by voting against
with 1/3 chance, without even stealing keys or completely replacing the
binary.</li>
<li><strong>Stealing keys</strong> - That would be pretty bad. Should not be possible with
sandboxing. We should at least not allow filesystem-access or network access.</li>
<li><strong>Taking control over the validator.</strong> E.g. replacing the <code>polkadot</code> binary
with a <code>polkadot-evil</code> binary. Should again not be possible with the above
sandboxing in place.</li>
<li><strong>Intercepting and manipulating packages</strong> - Effect very similar to the
above, hard to do without also being able to do 4 or 5.</li>
</ol>
<p>We do not protect against (1), (2), and (3), because there are too many sources
of randomness for an attacker to exploit.</p>
<p>We provide very good protection against (4), (5), and (6).</p>
<h3 id="job-processes"><a class="header" href="#job-processes">Job Processes</a></h3>
<p>As mentioned above, our architecture includes long-living <strong>worker processes</strong>
and one-off <strong>job processes</strong>. This separation is important so that the handling
of untrusted code can be limited to the job processes. A hijacked job process
can therefore not interfere with other jobs running in separate processes.</p>
<p>Furthermore, if an unexpected execution error occurred in the execution worker
and not the job itself, we generally can be confident that it has nothing to do
with the candidate, so we can abstain from voting. On the other hand, a hijacked
job is able to send back erroneous responses for candidates, so we know that we
should not abstain from voting on such errors from jobs. Otherwise, an attacker
could trigger a finality stall. (See &quot;Internal Errors&quot; section above.)</p>
<h3 id="restricting-file-system-access"><a class="header" href="#restricting-file-system-access">Restricting file-system access</a></h3>
<p>A basic security mechanism is to make sure that any process directly interfacing
with untrusted code does not have unnecessary access to the file-system. This
provides some protection against attackers accessing sensitive data or modifying
data on the host machine.</p>
<p><em>Currently this is only supported on Linux.</em></p>
<h3 id="restricting-networking"><a class="header" href="#restricting-networking">Restricting networking</a></h3>
<p>We also disable networking on PVF threads by disabling certain syscalls, such as
the creation of sockets. This prevents attackers from either downloading
payloads or communicating sensitive data from the validator's machine to the
outside world.</p>
<p><em>Currently this is only supported on Linux.</em></p>
<h3 id="clearing-env-vars"><a class="header" href="#clearing-env-vars">Clearing env vars</a></h3>
<p>We clear environment variables before handling untrusted code, because why give
attackers potentially sensitive data unnecessarily? And even if everything else
is locked down, env vars can potentially provide a source of randomness (see
point 1, &quot;Consensus faults&quot; above).</p>
<footer id="last-change">Last change: 2024-02-28, commit: <a href="https://github.com/paritytech/polkadot-sdk/commit/426136671a">426136671a</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../node/utility/candidate-validation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../node/utility/provisioner.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../node/utility/candidate-validation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../node/utility/provisioner.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../../mermaid-init.js"></script>
        <script type="text/javascript" src="../../mermaid.min.js"></script>


    </body>
</html>
