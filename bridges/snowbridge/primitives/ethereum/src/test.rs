// SPDX-License-Identifier: Apache-2.0
// SPDX-FileCopyrightText: 2023 Snowfork <hello@snowfork.com>

use crate::{
	storage_proof::{get_contract_account, get_value_from_proof},
	EIP1186Layout, StorageProof,
};
use ethereum_types::{H256, U256};
use hex_literal::hex;
use rlp::{Decodable, Rlp};
use rlp_derive::RlpDecodable;
use sp_io::hashing::keccak_256;
use sp_runtime::traits::{Hash, Keccak256};
use trie_db::{Trie, TrieDBBuilder};

/// The ethereum account stored in the global state trie.
#[derive(RlpDecodable, Debug)]
struct Account {
	nonce: u64,
	balance: U256,
	storage_root: H256,
	code_hash: H256,
}

#[test]
fn test_can_verify_account_info() {
	// source?: https://medium.com/@chiqing/eip-1186-explained-the-standard-for-getting-account-proof-444bc1e12e03
	let key = keccak_256(&hex!("b856af30b938b6f52e5bff365675f358cd52f91b"));
	let proof = vec![
        hex!("f90211a021162657aa1e0af5eef47130ffc3362cb675ebbccfc99ee38ef9196144623507a073dec98f4943e2ab00f5751c23db67b65009bb3cb178d33f5aa93f0c08d583dda0d85b4e33773aaab742db880f8b64ea71f348c6eccb0a56854571bbd3db267f24a0bdcca489de03a49f109c1a2e7d3bd4e644d72de38b7b26dca2f8d3f112110c6fa05c7e8fdff6de07c4cb9ca6bea487a6e5be04af538c25480ce30761901b17e4bfa0d9891f4870e745509cfe17a31568f870b367a36329c892f1b2a37bf59e547183a0af08f747d2ea66efa5bcd03729a95f56297ef9b1e8533ac0d3c7546ebefd2418a0a107595919d4b102afaa0d9b91d9f554f83f0ad61a1e04487e5091543eb81db8a0a0725da6da3b62f88fc573a3fd0dd9dea9cba1750786021da836fd95b7295636a0fd7a768700af3caadaf52a08a23ab0b71ca52830f2b88b1a6b23a52f9ee05507a059434ae837706d7d317e4f7d03cd91f94ed0465fa8b99eaf18ca363bb318c7b3a09e9b831a5f59b781efd5dae8bea30bfd81b9fd5ea231d6b7e82da495c95dd35da0e72d02a01ed9bc928d94cad59ae0695f45120b7fbdbce43a2239a7e5bc81f731a0184bfb9a4051cbaa79917183d004c8d574d7ed5becaf9614c650ed40e8d123d9a0fa4797dc4a35af07f1cd6955318e3ff59578d4df32fd2174ed35f6c4db3471f9a0fec098d1fee8e975b5e78e19003699cf7cd746f47d03692d8e11c5fd58ba92a680").to_vec(),
        hex!("f90211a07fc5351578eb6ab7618a31e18c87b2b8b2703c682f2d4c1d01aaa8b53343036ea0e8871ae1828c54b9c9bbf7530890a2fe4e160fb62f72c740c7e79a756e07dbf3a04dd116a7d37146cd0ec730172fa97e84b1f13e687d56118e2d666a02a31a629fa08949d66b81ba98e5ca453ba1faf95c8476873d4c32ff6c9a2558b772c51c5768a028db2de6d80f3a06861d3acc082e3a6bb4a6948980a8e5527bd354a2da037779a09b01ba0fe0193c511161448c602bb9fff88b87ab0ded3255606a15f8bca9d348a0c1c1c6a89f2fdbee0840ff309b5cecd9764b5b5815b385576e75e235d1f04656a04e827215bb9511b3a288e33bb418132940a4d42d589b8db0f796ec917e8f9373a099398993d1d6fdd15d6082be370e4d2cc5d9870923d22770aaec9418f4b675d7a00cd1db5e131341b472af1bdf9a1bf1f1ca82bc5b280c8a50a20bcfff1ab0bdd4a09bbcc86c94be1aabf5c5ceced29f462f59103aa6dafe0fc60172bb2c549a8dbaa0902df0ba9eed7e8a6ebff2d06de8bcec5785bb98cba7606f7f40648408157ef4a0ba9dfd07c453e54504d41b7a44ea42e8220767d1e2a0e6e91ae8d5677ac70e50a0f02f2a5e26d7848f0e5a07de68cbbbd24253d545afb74aac81b35a70b6323f1ca0218b955deca7177f8f58c2da188611b333e5c7ef9212000f64ca92cd5bb6e5a0a049cd750f59e2d6f411d7b611b21b17c8eefe637ca01e1566c53f412308b34c6280").to_vec(),
        hex!("f90211a05303302919681c3ad0a56c607c9530ed910f44515f6b40c9633d1900bbbc7e0fa0459fc49e57f39ca6471b1c6905ede7eaa6d7186c8249485cc28338ba18c540cba0825307726d1b7c9d74973d37c12e8b035bf0334836e48ec3f2ff18bf2232dabea0a67ef68daba820c7d6343d1b147b73430ce5c5915a27581cfd12946c2307dc49a003c9b0f0b784de7d72f3b5d5fea87e30dc5fc6f93a0c218240f79a2c74b0f8e2a05a38ddf70df168305b8ba38e8ee54dfadc3f7d81335ec849cb143a10d9738a91a058f0692b5cb07a1c8c800fcf8a70c6e6189a5d72f24ca0040423cf450df1da44a0890dbc62e7429fcca3f1507ad2cd4799c0a7aab25db37ccad434ae23ae889807a075be60d2f635292e69dbc600600605cb8eaf75e96425fd3f2347a5c644db43b9a07b65ba06ee9d2b5dab0a9acc1b8b521cb42f91566de9c174636e817c3d990265a0de65bc6092e28b0cc1ed454fcc07ce26df21bb05efe0a4b4472ff63278e28b95a08077cd7de83428d376ff7588b32df903d2764af7d41deb9c873e9ae889823cd3a0af2f63837dc01e2efb9e40815761015a0d740c2d2549593eefd291a05d40b55aa0c3214baa8d347bd5703926b6fe3ee2f607d0debc0fd73352696dc10f4cbc517da01756cf85b4785bda4a9867a453f8ca1948f015bd329b84083f14d313bddafb80a00dac89194bc1f28d3971b9ca9d1e16a49c6383557187d7bbeb899626d60bfb1980").to_vec(),
        hex!("f90211a0bf50b49fae6cfe8b7671e3fa0c163aed76f6457720a2b7c18f567b3c02194c29a070dc71bb7e399e5ae66958261108c84b75e8aacc8d255ce28cd7c9029358872ba0d2ae86d376e65eee52338ad4a1951deb9312f2c161fdf5cfc3e36d5a07ee4239a0f2029dea5033d0e788191ba25fc25bb0570bdbbaf321dfdb076f6695c649a07ca066074b59980560ecdd8ebc96eeb93f50dc1e92983659ea4a6a61a4cff0f474cba01ad85159ddc98609ea628cd17897fe08b0d9a7bb07a2087d92a673e063039aaba04921580f8766f8f156546abd8f0e44af250b34e7323f35c40fdc078223822344a034e07b24a1c17f5dcff27b766099c206fbbb6e549d3f4c02fd8db0241061482aa0c852267182c35e2e5014ab6d656672e9446aaf79c6248d103870d55ee36368b1a00aed203f7e2684942a64f05306e57d64fd44eded94e2ce95e462be93adff640da02cea88d74264c91c546de3822b6169a427559781a774511409864d70a834706ea01d542f8a9b69674e58a5bb89fafb5e79cbe3607732455b09c2a996df48e48837a04c3bbb4f47041018455347567a4e3af472fafe179871f667c3d26038f5dabacfa03c4f12f7cdd35126ce5452aa8322bc8b497eb06c5c41741b590d40645a8fd14ea01334e9a4160b44b622e9523cb587d8ba4795bbf9ad3dd0aa1a2b7f5c6a5cbe94a08feae3d50602063d65763185633aa6e23bb47eca9a39982a4863a7cc6d3586ff80").to_vec(),
        hex!("f90211a03fc22103871f30d114942583d24adfab1ce2e651ff6705a05964318fde7c425aa01c86fd2e9d2a823db33bf4089ce1af41332b4e3069b31bb70a67861944d71688a08a90ae88b4479d21135517195f50df20fc29dbe495e09440b0fa5797fc0352c8a02a195c4a89ab6322d8daa221124274d711a9435587406addfb289f9360c0b1caa02f7ed0113a1b72febc7ceb7d9193baeaa093aebea76eea4729821f53d29b302ea07d5cbbeffd22fb0f9d510576cac47a604b2121ef8b08588eaefc46a07844515ca01c0c09d203e342fab9f80835f3aa7bb7e94cbf94d3a18b21ce905e75b690673fa07c310f931f12d1651dbb9bdffbe5e0a16db981dccfb3f4a838592e2347b1b187a091b24e00d37034ed70e0c6653f8616363efbea43be86d52aabf6a9c5d5049d3aa017cc8ab2e63508691dee64ddb2dbe5352fe531f55728368cab3d8634450730dca0d8ee92d688eabcdf28af1830d7217fcd1431c0b0e3311039c422c5f45f9d525da0abe4323ef90fb783ffd6bf29d240818b0a2477d2ad4577fce57642a5ba476957a0eee3fbc510b1a6d8da176b9eab2035837769988b216fcef67f6a215e5e261d5ea082bc27591d8b0408739712c2f0e623e3d296d12afd6b7356dae237a315a6ce3ba0634affb8f9744fed774851772cb5ce495c50212961a64262d915632c2bede721a0345017d846f3be29dca1f56a734886c26cb49d3bcbbae5f7356e55e71d84147d80").to_vec(),
        hex!("f90211a0a152d08043b3865248d8ae9c4594d6e09079f61ee4ad9afca98d3befb3a9307ca01313ea4df7ec991f5ba1b2175408765ea67111857ae25cafe21986810d633353a05cb00f30a4b6749cb8d01dda2ad665a2c570b7c6959b364c46da75fc2aebfa14a0a493d42fa40d6c8fb23090f20cebe9f1cde8a47d9594e666096c3f76219cfb34a06d2149e05ba1a31bcc352fd3a79fd42d95383f14a312862fa5f4b7b7bdb63254a0f40094679bf0599fdeecae8c800a423ad2499b67f9546d4085d5b7a351561072a05036fc625ed5a13d143fd0984e99969d2d48f962baec80b3f0e78323c8e864ffa0c0887db54ab0d4309ed5f563448bfc78a4a88c3a5473fcbd9bd263c8fcca4b9fa04287b193a315cba13a49482b4d83c068cf08b622593111e416b7a3b815e3595aa051b82224b54dc4050703157cdd6c74c618872c798badce7192fe1fd534814d5da017ac02273956b25dc2429750156e0a45bf461437bec84b784d19a5b964dd6882a05be9c25f80a6f34e9eb526d6c3c89e3ec2c5dd769d2d915d835208cac3f56d36a0ea7ae8e74baeae9d6307371f85cce46ba7ad46b5c2b3616a3573a26e1260bc31a04446678b6bf75075ae0261c179d88e49fae1d9482c214ec8c693239b583a6b18a09ec91d47f671c343cea224def0afcd62a57a408ac0e36b79cf29a4495ff9055ca0c3da71d14030daf8fb9157ec84f077df97dff395c1fcf8f04361e02aa1af36ff80").to_vec(),
        hex!("f8b1808080a038f5e1b2680d95eaf7f225b996fc482f60cabcebeae26f883a4b58e1e9c7bbeda0c220c5d76d85ad38d8f82d0d6d6f48db3c23ae3657d1ac3ca6e2d98b4e48bfde8080a06fe32c7c1f8f80ebe5128f11a7af3a5bc47dbc6ac0af705069532b1cbefd6792a0015eb7d24835c910fc5f906627968a1a9e810cb164afd634ca683b6bb34f0241808080808080a03ca1d0ead152d38c16bda91dac49e3f0c9a0afeaa67598c1fce2506f5f03162680").to_vec(),
        hex!("f86d9d3c3738deb88e49108e7a5bd83c14ad65b5ba598e2932551dc9b9ad1879b84df84b10874ef05b2fe9d8c8a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470").to_vec(),
    ];

	let root = H256(hex!("024c056bc5db60d71c7908c5fad6050646bd70fd772ff222702d577e2af2e56b"));

	let db = StorageProof::new(proof).into_memory_db::<Keccak256>();
	let trie = TrieDBBuilder::<EIP1186Layout<Keccak256>>::new(&db, &root).build();
	let result = trie.get(&key).unwrap().unwrap();

	// the raw account data stored in the state proof:
	let account = Account::decode(&Rlp::new(&result)).unwrap();

	// some assertions about the account data in the state root.
	assert_eq!(account.balance.0, U256::from_big_endian(&hex!("4ef05b2fe9d8c8")[..]).0);
	assert_eq!(
		account.code_hash,
		H256::from(hex!("c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470"))
	);
	assert_eq!(
		account.storage_root,
		H256::from(hex!("56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421"))
	);
	assert_eq!(account.nonce, 0x10);
}

#[test]
fn test_can_get_gateway_asset_storage_value() {
	/*
	1. get the account proof for the gateway contract (0x27ca963c279c93801941e1eb8799c23f407d68e7) at block 23597879 (0x1681337),
	specifically for the storage entry `AssetsStorage.assetHubAgent` located at SLOT keccak256("org.snowbridge.storage.assets") + 1
	which corresponds to: 0x8d3b47662f045c362f825b520d7ddf7a0e5f6703a828606de6840b3652b8c22f
	curl https://eth-mainnet.alchemyapi.io/v2/key \
		   -X POST \
		   -H "Content-Type: application/json" \
		   -d '{"jsonrpc":"2.0","method":"eth_getProof","params":["
				0x27ca963c279c93801941e1eb8799c23f407d68e7",["8d3b47662f045c362f825b520d7ddf7a0e5f6703a828606de6840b3652b8c22f"],"0x1681337"],"id":1}' | jq .
			*/
	let gateway_contract = hex!("27ca963c279c93801941e1eb8799c23f407d68e7");
	// Proofs from the response
	let contract_proof = vec![
		hex!("f90211a055bbafcdc7a550caf95c3e8fa2f742206f407936c844645254f2a2b4e59a6216a04c7b38c818a714c93dfec00ce931c99ffccc7020f2d5a3d773f02af80b1f1983a030c9fb0c6e683c524bab23a604ad95cca59f4ef858b8eeb5f4bf220af7e2a8fba06245e14dd2d1729d1cbef150503e0897defed3ecaca9603283fb8a1413ea6315a02620cdd4bac6f03205cae1884aa3544c26884e9dd6ef71d44c25cc27a016f15ea019c7c359ce097bd9a21a55dea058afcd1a93abfa6c65c94ce4c3d874bf1ab55ca082b1af1a8cce8076ae2106caf8dd993b12e55574db726a6a8ad30625f62a12ffa0edda546838eb81c74ff632b69d17866fedf2f9d05b37c914db8a3364c9c4a8c4a0ac91e14f73a61109882a8de2cc8d0357bccf53a26d4fa1a17c80a542eff0e4d3a0daffd837c29333cc082d96777dc5eedf2500b7cb4d5bc636118df02d8af974efa09c8e1a90e51811b395945bd924226ca588789eeb50daab57363f5bd55f6d08ada0f4e9119d824e1bd915200034a80f5cc16ca23394a11af4e8591e545f18dca33fa0a4e4ff5a9cf55c1a2fa04dcb628fb043c696ff97a4e2401c5a245abe187b9886a0f69ec952d109e64f9aa34132a96c7ce4bd67923539fd254f1abdb7dfa5bf555aa06d2ccd216a9a9b630d90b62020609498048ac48ab68c727a7d8f4f67a1eee075a02aeca305e25e529786b669cf8eeb377200aa9a89e8eb57929d4ba74958205e6880").to_vec(),
		hex!("f90211a06bcec08b5903accf7f3dc6f50e7c0a6525c1917f716454446e1636e7d5252c1ca0143289a9f8148aa09904ff6706577a5a73c99265d919d884eb5ceb4ac172c398a0f975bff3a4ef478b662c690b1433c372c63e7af201ce4ee491c0a8465248ff7ea085ef8ff7ea74b137ad3e5d2711637db8c00a5e03edb563a345979d9da179a3a3a08776f7580eed0a189bbc6a32029d9c6c51f40645b3669b7d9cd97565c22deb8ba0663912988ad8e240b622cd0061a8c79b962153c6e248b02989d537c1ad887238a08f8f2cb6f218c291d89eac5b1f421eb7b72de71c9620d6d3c9c1ea01d0b28f56a000093066d8758db410af63253a8a820d1b361ec52a46827b039296e72d121951a0df9606966bbc7c67ffefab4d8d709475e8ecdd2ba9943b8b042d9400c73b3169a01fed4ca28f70760df326a9201906c7fee1fbab06e0bcd230121877f790f8f9e0a0e479da474d9d6114ac92124b3fce4f94698da91604d8170a82f856d891b25900a029b5b587a4edf8128a52ccbae5842501fd4eaa0e140d5c0e635c1613e31b6d2fa0958baa90049b22c29044c6aa202e817bf5c0562988fdbb5a79e9b24d11d59520a096dfb8c0b974e3de0afe2b0bc9c69c23a43ab92ca970bbda2985ba7528d1f903a094b8492901a5cd20d5ba2ef7f0cc5aa64f29fc4329e4754c59611b5fbb4d773fa0183cf362236949eb2c10bc222da3066ba16cffac1a3d91cc1a6191c74c11a02280").to_vec(),
		hex!("f90211a09343354163663148c829a0e370bac59c89dd1e18412ddb0ee15082016c80eec7a0c3f215e6c41f0247dc766ed4dc649c0ae9af5a677a4d1f07bd213872aa231cbea06168074f292deff039a7c3cfd6bae6ea1981d296320f0071e9da5065fb39371ba0e0390908dbd73f945abc95312792c919372d822aaa923d2dc0b32bf33e85607fa065446370bce5ab6d0eec794e4bd7ade4cd26c8aece51ef7112075f6f3a1326e7a028b09c11577747204ee9d5b8b95832d872f68fcaa964d10191fbd78f419c9384a0299589015c702607c294497b40e77c3778220edf3a6430b309c503532ac36e48a0f03fcdd079d7236796bc718d607bdbd4458abb45c11e2079581a80bd7155d7b7a080e6c1f7190ed23c2c7308c86d11d6d570e999a0e0bb21df0bd31c85e10786a6a0a00c27a5a079cf50ee3c15c0d8949b96e59ba902765b2699d13e2802387faec2a0ad42181a189fe260fbf72f3fc593ed37248473d1317ceb0d2fc72459210a8d2ea0a9d3cae3786c3bfc669e1c99531ca21095f1bf469439b7d9cac37dc7a48511eea0115350c5c477b269d1449e83f9617a7500b9dcfa696ea076e34d9e8df707057aa0bd2a1d9f21d1dc6907471687b66835cd66085cc9b035df3ddaa611753d0b4bdca0647662f0dc9d40e2154ace3032c65fb4b3e35e04f94411c47ce1e684920dd7a9a0621939cb78e5efd47c3326857ef8198d7cccf6e10e994515ba5e9f0efd59860280").to_vec(),
		hex!("f90211a046af213288c6e1a836beed1a6080d0d369652fc878710d8cc6fc0c0ad6cc7d8da0d50769a8ed6e1ab9633d08305e22dc44c219ec2e86b52e5a8aa84555ec3c213ca0dab11e20a190dc050a6a6b76f3924357164f46d4a80944093748a836b28e2666a0363f7ab0143847e2e32ab513deefacbc61ca3a1b5df1a3861a3e2365362a1e09a05d0012d05557730d7e062b6a34999db532c9c628a97550dc34b8b5a09005f0b9a0f016b6741c37ec58dc829bb95a3c4bbca3c48d7f12d0e14906f7553e933e7fc7a06c55795baa9b192d651f735df93910643bd272d0befe4dfb479d5d4aedfcd4b5a0d456c953c3235ac1b60b0d381be648fd3c0adf5d0549c3cee52e9cb1e93ef4d9a0f66442c2b9c179c5c358f557701b7f1068ca07e744163ce0fc3166ca2feda127a08f3bda52b7a03c7535d3514d4e330268197412517386c88482d88f4cdb6dcc19a04810019142b520bacdf0ece526663e5b3456ff177fdee5ed79e3ab35fd12118ca0d90c86f43cb3f4bea21e003cbce8df789e00d4f3c0391a18282d680744ad1e96a0df0e39d37ebfb3db210c843f12eb861b753be9fba271dae5bd77bef06083b01da05916fca595058784bd599e9c414d0f680e725137ef1a3dae55509560a5374a89a03b58fd89ebaf4a8d2995afae1f331d1703431105fe5164dd9d87406823bc42a4a0445d8e66998f04c10b6ab7c434ff0cc5bbaa98da11f251cb81fa8fb4b9b5e26680").to_vec(),
		hex!("f90211a0884b22a4c0e80aabe0298f03648ad4676549d9dbfd7ad2ae5304be3962e2ec65a099948835d2eb4bf8e722bf649834312ad58962efa8577d3d71f5ad2d72a72b4ea05f69938cebfec6ce10c22f562bd3c3d04e982c7f4ff85b393f2b30c65476e55aa0d6547af01e5d07c435c3ac2c4d8dc85bada4d69b7a12c1e58431bebe0494b47ea097be6e5baeb4b2ad8d2df0b8b55cefcebb9e01e935247ac1518471b69fd98af0a06be1a0808a151d205215725bf467b30db227a43e8f80ca20a3beca0b7a185337a0039034393eb37a43513320826788bc3baf50dc84c46b7c17a9188ad5a582c110a06d6abca285ae465268cc8f314b991aa1136dd4cf3cb437c5e3f3fcac61e73f30a074fac071d08bc2fca3e141d34781d53d4268113d44726a2ffdbb04bdc10cb8b1a0e90258dbb2d4b044532e943583fb9b12f2bd3c6ef4fd0a6eb749772635634389a0dfe070454c7c69078236e8ea25e6bd8c93184e8785c741bf9c97ed20885c8faea0eeb860cb604b904b1f22d69aa667ce3c36b741b8dade2933f77d8fb056ba066ca0c7e1afa119e4b9cfee88521c29b75c4e0c23f33ce21f495f67fc1bdf328e2eaaa08225b398d4f3af637183ef183d6bdd39f0cbd18cf347df4c494a4b9f883f16eaa06ca4003dedb196b7305bc8e53ae9652c3425c33afba74fe7188763236994a67ca06f92eb5b965b5903665fa329ab4d6f2c0a546f4b34afa4b8a82b84891aaa6b2f80").to_vec(),
		hex!("f90211a07bd0979b05724e5b80528d1e4a839ea8c039ae9b7b707ab0b6adf23e5591e195a08d751a431f368068fb8e0224122b04323cf60d13e9468936073df37358360a1fa0d38cce89ba9b554cefb9ef198b2d92d9b1f562855c69b37ea10c36f81918abcaa0ade6dc47f09216aaab8b02f4ee2a3260457749499f60a2c2e923210ac8770622a0ae7e5b3b7d6bd515e27d15afa5bc2309e35797805179421cfbd05a3aa5d83f9fa0af740213327f71e83393c64d8ce9da1738c51b0e799b3b4686262347f2388b67a04d63e9be4cbbc6f04e420779456da8507261f01e73a583f854624fe4ff00ef8ba0643187c27155cb5c73c9ec585677d16fbc980d7d93170708c075321d6d1e5633a03ff39600f94d28deadb31b9ccd47492d907b861c68b9a327d6a16cb63ebb2bd2a0ca351002db204dbc1f981a9c358fa91698f18e53dfbfb3140b69b9f63efba5afa0245d5136adfecd9663b0d32fe382eedc40814d6f2e00edbe421993e3e6db8027a0fc69e81b680d9a062cbb1b6b9a40f4943e826d7fc7140cbf37336b21fd4852eba0844e320c986bb3edd1d2bdcc8421adf1f043d5d327f281d6d06e172db51e7600a0d3886be90808af12005176d83ea14a962c9a49864df8c9c3b6e2f79b78a3cedda0bedf6fa9c6b41a6a12674bc1c67fa8ca0194d660c731356985ef57fd2e804d44a017c2468e2e326cd3eb2d5f3f22fc79aa691a1aa991ac7733c29f21235049448d80").to_vec(),
		hex!("f90211a0b308d5fcc210d6baa1f9535fc1fbf60f4ab0a4fa6a553d3f762c618ad8b79dd0a08269b1dd4ff559396097a4bfe482432c45e64753265f00c9a1c534818d91a5a2a02d3e337715ce19fc4dbedfe6c7aa078e4f3fef102f1e1bb033f83215b01a13caa0f423efcb0121d9659d7b4c49e917029c2e1501c17f719482757089ef87b7903fa07a52c334625016e66735caa631bb77499f8915b4b28dd3555a83cb9dabf23ec8a0a3eeac56f9724d57ed5cb4cfd1b67a554b81994ef94b6c68b2ef1d8632fc783aa08eb40f8fa37e7a17ddc2fb80af5a36cb9c8b599daf05f20acd7182e6728653b7a0c2efeed17f49635a312c3c1b9dd25603f5c3d9fe29e4db63320a758507e685e6a06e1dc105ed9a37862f59a4bcb95aeaee3fcbef48457ff4cce517b093834f275fa0205f776adcf0b1f765ec3e5b15996c981ae221f3bf6f99e5b18c425cc4d309fca0377d65ef3a92db6523d5476604811f5da6af622e6be473998d4fb175dfccd2aba026881f8ca04cf21d9730c63d9fc85f9bff559f84eaea70fc606cdf5d01e69ad3a01a7ead1413fe44b327ecfecd9f64b803cb2b806f7fa338f0bc094a1235338e71a083a342a91d1ed5286711585a724a7d88309cff5508cf9fff902ad35517e07b43a0724169b2b2567d67d6800f77786ab0937441583c7f750cc53762ddd5eabe276ba024306b8e21871865c903710c58ea55293f4e003ce70ba530a0dfbc16a070686580").to_vec(),
		hex!("f8718080808080808080a0a33e2cbef0b9a32b10c5a4e9fb38548571b7e5bf86f1ca262e947da048e2443980808080a014a97ca28d2569dfa4ccd44777bc651d4aa722f450994ea60b398a6c3a1a7220a0e4d1c3c700d63192e7248f7f438bdf38442eabc0100adde67b0e2eccf978a4c48080").to_vec(),
		hex!("f86e9d20a7e0fe655df4051644711bc6f37481a29575edb4ec4f1dbe3803bdb5b84ef84c1c880400f9179048b5f3a0fbb82dbfe50e552cfbd341733fc2e8963104411ca99f6418208f20666326b7c9a0a64a5bd2f4403a9590cb4ffaabc86faf90337177ff073ad5a38d9e36b8116d25").to_vec(),
	];

	// 2. get state root at block 23597879 from etherscan: https://etherscan.io/block/23597879
	let state_root = H256(hex!("9cd9def7a92edd92d6160083bf9c9e108cc42369b642d2b40e05972f93f1ac35"));

	let contract_root = get_contract_account(contract_proof, &gateway_contract, state_root)
		.unwrap()
		.storage_root
		.0;

	assert_eq!(
		contract_root,
		hex!("fbb82dbfe50e552cfbd341733fc2e8963104411ca99f6418208f20666326b7c9")
	);

	let storage_key = Keccak256::hash(
		hex!("8d3b47662f045c362f825b520d7ddf7a0e5f6703a828606de6840b3652b8c22f").as_slice(),
	);

	let storage_proof = vec![
		hex!("f90211a04ec1bb883be96a95b15f7eda43e718833dca6ac8cf475d117dfd00ab9acbe7aba03eefda387110581ae2cffbc0e429348ccddb4d819617d450e973959dd750828aa09c30b06baad447d4a3c357418ef4f47b03246f114f3599fee336285d6e05f96aa012d1dca17bfd790632282e007f018f9cda9ad14481157ae95f51142bba26eec1a085764c4b50512d45e8af555a859b3bcf37cf599ecc30185126e695621549a821a037cd7ae73631f7c8b002f711ed47f08d2287f4089313e659d5529eee3b91ae07a09cce987033046d8cf326b655daae096254a7565eafa2f8012cbece9afce43a7fa04d083eb506f6a0675aa7d8bf5729d52bf5b52d47e5291feea98adfbad9789109a08b303d1f9e3f58581b0cfb682fbafa019acc5fded0b49847ecefaed76679eaaba0e0241ce1c320f87c49127e24ff545cae920444f08c18bec6e7d81abfb52c1ab6a05fc321a1a17ce96be4dcb297ba1d691f2c17db554dde518dba36887bfb1666eda011219dc5b1f5b03a354347aa6271135a015b1988a53ebed7a2f13d96d04ad050a033883421cd8a7163f71814e69734b67aeda8e316f06333e2d974516f0dd4123da064927240cfb94ca24abeb0361643da3ae84d0095298ce491055760ab484892ada07aa03ebeb71407ea9c3071bdc280c9ac0755ee71ad5a3624861b2b682fea53a6a0cc4e2a0deb36bffc29a255048c45b94989468fd8e8d6ffef8519540f0a20151180").to_vec(),
		hex!("f9013180a0e404c3947a78b239b04e8a5c08ed0bb7fee9e0f9c3f49de0d48de3926c0674d58080a063e9982f6ba5f707bd7012958232fe0be6dd6007d404505f3bbda9a86e5ef332a0e0487b0dcdb9c818e2332a02afa33cffc694d0e4ef69297686197cbd67a86cf180a082c64d76a8a019f3c2ded2985fc49d9d023b83925d2838a63ae084d4ac7632b5a0e10fde19958337776ff7abec147a0511656dd12b0cc1e3f0062750c546fd2693a028914ec552a3868853c9f955f24dbb3ea504f849041d628a538cb774cdc7a76da065a5455b6a5f670d9ba073bb0ec8b8ab4498b414214df781320e4b33e848c83280a0092b9c9dcb1c39047c103b678c7412dee5db1ea03abb4bd07b524c04f22d877b80a084d88d219a4e83dbd3ec20aa8033ebb43f521ceaf85caf34400c4c65e7fe31cd8080").to_vec(),
		hex!("f839a02038de597b11fead1f10bb2cfb71a1f3a056e637f8e2d1af99eaebc3d321df74979603e8d803472c47a87d7b63e888de53f03b4191b846a8").to_vec(),
	];

	let value =
		get_value_from_proof(storage_key.0.to_vec(), contract_root.into(), storage_proof).unwrap();
	assert!(value.is_some());
	let value = value.unwrap();

	let decoded_address: alloy_primitives::Address =
		alloy_primitives::Address::from_slice(&value.as_slice()[(value.len() - 20)..]); //address!(value.to_hex());
	assert_eq!(
		decoded_address.0.to_vec(),
		hex!("d803472c47a87D7B63E888DE53f03B4191B846a8").to_vec()
	);
}
