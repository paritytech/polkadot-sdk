name: Check links

on:
  pull_request:
    paths:
      - "**.rs"
      - "**.prdoc"
      - ".github/workflows/check-links.yml"
      - ".config/lychee.toml"
    types: [opened, synchronize, reopened, ready_for_review]
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  packages: read

jobs:
  isdraft:
    uses: ./.github/workflows/reusable-isdraft.yml
  link-checker:
    runs-on: ubuntu-latest
    needs: isdraft
    timeout-minutes: 10
    steps:
      - name: Restore lychee cache
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.2 (12. March 2025)
        with:
          path: .lycheecache
          key: cache-lychee-${{ github.sha }}
          # This should restore from the most recent one:
          restore-keys: cache-lychee-

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4.1.0 (22. Sep 2023)

      - name: Lychee link checker
        uses: lycheeverse/lychee-action@885c65f3dc543b57c898c8099f4e08c8afd178a2 # for v1.9.1 (10. Jan 2024)
        with:
          args: >-
            --config .config/lychee.toml
            --no-progress
            './**/*.rs'
          fail: true
        env:
          # To bypass GitHub rate-limit:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
