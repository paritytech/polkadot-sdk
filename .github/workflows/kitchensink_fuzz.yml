name: Kitchensink Fuzz

on:
    push:
    pull_request:

jobs:
  fuzz:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get PR Details 
      run: |
          # TODO: (hardcoded for demo, pedning to push PR)
          # This is a placeholder to find affected pallet in the PR and post the coverage report

    - name: Fuzzer target and cargo cache
      uses: actions/cache@v4
      with:
        path: |
          substrate/bin/node/runtime/fuzzer/target
          ~/.cargo/
        key: fuzzer-target-and-cache-dirs

    #- name: Install Rust target
    #  run: rustup target add wasm32-unknown-unknown

    - name: Install dependencies
      run: cargo install ziggy cargo-afl

    - name: Build fuzzer
      env:
        SKIP_WASM_BUILD: true
      working-directory: substrate/bin/node/runtime/fuzzer
      run: cargo ziggy build --no-honggfuzz

    - name: Fuzz for 5 minutes
      env:
        SKIP_WASM_BUILD: true
        AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES: true
        AFL_SKIP_CPUFREQ: true
      working-directory: substrate/bin/node/runtime/fuzzer
      run: timeout 5m cargo ziggy fuzz || [[ $? -eq 124 ]]

    - name: Upload Fuzzer Output
      uses: actions/upload-artifact@v4
      with:
          name: fuzzer-output
          path: substrate/bin/node/runtime/fuzzer/output/kitchensink-fuzzer/afl/mainaflfuzzer/fuzzer_stats

    - name: Get Coverage 
      run: |
        # TODO: 
        # This is a placeholder to get gcov report

    - name: Post the coverage report in PR
      run: |
        # TODO: 
        # This is a placeholder to post the coverage report in PR
