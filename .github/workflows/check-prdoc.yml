name: Check PRdoc

on:
  pull_request:
    types: [labeled, opened, synchronize, unlabeled]

env:
  # todo: switch to paritytech once built+published
  # see https://github.com/paritytech/scripts/pull/595
  IMAGE: chevdor/prdoc:v0.0.4
  API_BASE: https://api.github.com/repos
  REPO: ${{ github.repository }}

jobs:
  check-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Pull image
        run: |
          echo "Pulling $IMAGE"
          docker pull $IMAGE
          docker run --rm $IMAGE --version

      - name: Check if PRdoc is required
        id: get-labels
        run: |
            # Fetch the labels for the PR under test
            echo "Fetch the labels for $API_BASE/${REPO}/pulls/${GITHUB_PR}"
            labels=$( curl -H "Authorization: token ${GITHUB_TOKEN}" -s "$API_BASE/${REPO}/pulls/${GITHUB_PR}" | jq '.labels | .[] | .name' | tr "\n" ",")
            echo "Labels: ${labels}"
            echo "labels=${labels}" >> "$GITHUB_OUTPUT"

      - name: No PRdoc required
        if: startsWith(${{ steps.get-labels.outputs.labels }}, "R0")
        run: |
          echo "PR detected as silent, no PRdoc is required, exiting..."
          exit 0

      - name: Check PRdoc
        if: ! startsWith(${{ steps.get-labels.outputs.labels }}, "R0")
        env:
          MOUNT: /prdoc
          GITHUB_PR: ${{ github.event.pull_request.number }}
          # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TODO
