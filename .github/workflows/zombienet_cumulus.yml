name: Zombienet Cumulus

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  merge_group:
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  RUN_IN_CONTAINER: 1
  FF_DISABLE_UMASK_FOR_DOCKER_EXECUTOR: 1
  LOCAL_DIR: "./cumulus/zombienet/tests"
  GHA_CLUSTER_SERVER_ADDR: "https://kubernetes.default:443"

# only run if we have changes in [subtrate, cumulus, polkadot] directories or this workflow.
jobs:
  isdraft:
    uses: ./.github/workflows/reusable-isdraft.yml
  preflight:
    needs: isdraft
    uses: ./.github/workflows/zombienet-reusable-preflight.yml

  zombienet-cumulus-0001-sync_blocks_from_tip_without_connected_collator:
    needs: [preflight]
    if: ${{ needs.preflight.outputs.changes_substrate || needs.preflight.outputs.changes_cumulus || needs.preflight.outputs.changes_polkadot }}
    runs-on: ${{ needs.preflight.outputs.ZOMBIENET_RUNNER }} # NOTE: should be zombienet-arc-runner (without quotes)
    timeout-minutes: 60
    container:
      image: ${{ needs.preflight.outputs.ZOMBIENET_IMAGE }}
    env:
      RELAY_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/polkadot-debug:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
      COL_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/test-parachain:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: script
        run: |
          echo "RELAY_IMAGE: $RELAY_IMAGE"
          echo "COL_IMAGE: $COL_IMAGE"
          export DEBUG=${{ needs.preflight.outputs.DEBUG }}
          /home/nonroot/zombie-net/scripts/ci/run-test-local-env-manager.sh \
            --local-dir="$(pwd)/$LOCAL_DIR" \
            --concurrency=1 \
            --test="0001-sync_blocks_from_tip_without_connected_collator.zndsl"

      - name: upload logs
        uses: actions/upload-artifact@v4
        with:
          name: zombienet-logs-${{ github.job }}-${{ github.sha }}
          path: |
            /tmp/zombie*/logs/*

  zombienet-cumulus-0002-pov_recovery:
    needs: [preflight]
    if: ${{ needs.preflight.outputs.changes_substrate || needs.preflight.outputs.changes_cumulus || needs.preflight.outputs.changes_polkadot }}
    runs-on: ${{ needs.preflight.outputs.ZOMBIENET_RUNNER }} # NOTE: should be zombienet-arc-runner (without quotes)
    timeout-minutes: 60
    container:
      image: ${{ needs.preflight.outputs.ZOMBIENET_IMAGE }}
    env:
      RELAY_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/polkadot-debug:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
      COL_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/test-parachain:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: script
        run: |
          echo "RELAY_IMAGE: $RELAY_IMAGE"
          echo "COL_IMAGE: $COL_IMAGE"
          export DEBUG=${{ needs.preflight.outputs.DEBUG }}
          /home/nonroot/zombie-net/scripts/ci/run-test-local-env-manager.sh \
            --local-dir="$(pwd)/$LOCAL_DIR" \
            --concurrency=1 \
            --test="0002-pov_recovery.zndsl"

      - name: upload logs
        uses: actions/upload-artifact@v4
        with:
          name: zombienet-logs-${{ github.job }}-${{ github.sha }}
          path: |
            /tmp/zombie*/logs/*

  zombienet-cumulus-0003-full_node_catching_up:
    needs: [preflight]
    if: ${{ needs.preflight.outputs.changes_substrate || needs.preflight.outputs.changes_cumulus || needs.preflight.outputs.changes_polkadot }}
    runs-on: ${{ needs.preflight.outputs.ZOMBIENET_RUNNER }} # NOTE: should be zombienet-arc-runner (without quotes)
    timeout-minutes: 60
    container:
      image: ${{ needs.preflight.outputs.ZOMBIENET_IMAGE }}
    env:
      RELAY_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/polkadot-debug:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
      COL_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/test-parachain:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: script
        run: |
          echo "RELAY_IMAGE: $RELAY_IMAGE"
          echo "COL_IMAGE: $COL_IMAGE"
          export DEBUG=${{ needs.preflight.outputs.DEBUG }}
          /home/nonroot/zombie-net/scripts/ci/run-test-local-env-manager.sh \
            --local-dir="$(pwd)/$LOCAL_DIR" \
            --concurrency=1 \
            --test="0003-full_node_catching_up.zndsl"

      - name: upload logs
        uses: actions/upload-artifact@v4
        with:
          name: zombienet-logs-${{ github.job }}-${{ github.sha }}
          path: |
            /tmp/zombie*/logs/*

  zombienet-cumulus-0004-runtime_upgrade:
    needs: [preflight]
    if: ${{ needs.preflight.outputs.changes_substrate || needs.preflight.outputs.changes_cumulus || needs.preflight.outputs.changes_polkadot }}
    runs-on: ${{ needs.preflight.outputs.ZOMBIENET_RUNNER }} # NOTE: should be zombienet-arc-runner (without quotes)
    timeout-minutes: 60
    container:
      image: ${{ needs.preflight.outputs.ZOMBIENET_IMAGE }}
    env:
      RELAY_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/polkadot-debug:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
      COL_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/test-parachain:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/download-artifact@v4.1.8
        with:
          name: build-test-parachain-${{ needs.preflight.outputs.SOURCE_REF_SLUG }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ needs.preflight.outputs.BUILD_RUN_ID }}

      - name: tar
        run: tar -xvf artifacts.tar

      - name: script
        run: |
          echo "RELAY_IMAGE: $RELAY_IMAGE"
          echo "COL_IMAGE: $COL_IMAGE"
          ls -ltr *
          cp ./artifacts/zombienet/wasm_binary_spec_version_incremented.rs.compact.compressed.wasm /tmp/
          ls /tmp
          export DEBUG=${{ needs.preflight.outputs.DEBUG }}
          /home/nonroot/zombie-net/scripts/ci/run-test-local-env-manager.sh \
            --local-dir="$(pwd)/$LOCAL_DIR" \
            --concurrency=1 \
            --test="0004-runtime_upgrade.zndsl"

      - name: upload logs
        uses: actions/upload-artifact@v4
        with:
          name: zombienet-logs-${{ github.job }}-${{ github.sha }}
          path: |
            /tmp/zombie*/logs/*

  zombienet-cumulus-0005-migrate_solo_to_para:
    needs: [preflight]
    if: ${{ needs.preflight.outputs.changes_substrate || needs.preflight.outputs.changes_cumulus || needs.preflight.outputs.changes_polkadot }}
    runs-on: ${{ needs.preflight.outputs.ZOMBIENET_RUNNER }} # NOTE: should be zombienet-arc-runner (without quotes)
    timeout-minutes: 60
    container:
      image: ${{ needs.preflight.outputs.ZOMBIENET_IMAGE }}
    env:
      RELAY_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/polkadot-debug:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
      COL_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/test-parachain:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: script
        run: |
          echo "RELAY_IMAGE: $RELAY_IMAGE"
          echo "COL_IMAGE: $COL_IMAGE"
          export DEBUG=${{ needs.preflight.outputs.DEBUG }}
          /home/nonroot/zombie-net/scripts/ci/run-test-local-env-manager.sh \
            --local-dir="$(pwd)/$LOCAL_DIR" \
            --concurrency=1 \
            --test="0005-migrate_solo_to_para.zndsl"

      - name: upload logs
        uses: actions/upload-artifact@v4
        with:
          name: zombienet-logs-${{ github.job }}-${{ github.sha }}
          path: |
            /tmp/zombie*/logs/*

  zombienet-cumulus-0006-rpc_collator_builds_blocks:
    needs: [preflight]
    if: ${{ needs.preflight.outputs.changes_substrate || needs.preflight.outputs.changes_cumulus || needs.preflight.outputs.changes_polkadot }}
    runs-on: ${{ needs.preflight.outputs.ZOMBIENET_RUNNER }} # NOTE: should be zombienet-arc-runner (without quotes)
    timeout-minutes: 60
    container:
      image: ${{ needs.preflight.outputs.ZOMBIENET_IMAGE }}
    env:
      RELAY_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/polkadot-debug:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
      COL_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/test-parachain:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: script
        run: |
          echo "RELAY_IMAGE: $RELAY_IMAGE"
          echo "COL_IMAGE: $COL_IMAGE"
          export DEBUG=${{ needs.preflight.outputs.DEBUG }}
          /home/nonroot/zombie-net/scripts/ci/run-test-local-env-manager.sh \
            --local-dir="$(pwd)/$LOCAL_DIR" \
            --concurrency=1 \
            --test="0006-rpc_collator_builds_blocks.zndsl"

      - name: upload logs
        uses: actions/upload-artifact@v4
        with:
          name: zombienet-logs-${{ github.job }}-${{ github.sha }}
          path: |
            /tmp/zombie*/logs/*

  zombienet-cumulus-0007-full_node_warp_sync:
    needs: [preflight]
    if: ${{ needs.preflight.outputs.changes_substrate || needs.preflight.outputs.changes_cumulus || needs.preflight.outputs.changes_polkadot }}
    runs-on: ${{ needs.preflight.outputs.ZOMBIENET_RUNNER }} # NOTE: should be zombienet-arc-runner (without quotes)
    timeout-minutes: 60
    container:
      image: ${{ needs.preflight.outputs.ZOMBIENET_IMAGE }}
    env:
      RELAY_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/polkadot-debug:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
      COL_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/test-parachain:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: script
        run: |
          echo "RELAY_IMAGE: $RELAY_IMAGE"
          echo "COL_IMAGE: $COL_IMAGE"
          export DEBUG=${{ needs.preflight.outputs.DEBUG }}
          /home/nonroot/zombie-net/scripts/ci/run-test-local-env-manager.sh \
            --local-dir="$(pwd)/$LOCAL_DIR" \
            --concurrency=1 \
            --test="0007-full_node_warp_sync.zndsl"

      - name: upload logs
        uses: actions/upload-artifact@v4
        with:
          name: zombienet-logs-${{ github.job }}-${{ github.sha }}
          path: |
            /tmp/zombie*/logs/*

  zombienet-cumulus-0008-elastic_authoring:
    needs: [preflight]
    if: ${{ needs.preflight.outputs.changes_substrate || needs.preflight.outputs.changes_cumulus || needs.preflight.outputs.changes_polkadot }}
    runs-on: ${{ needs.preflight.outputs.ZOMBIENET_RUNNER }} # NOTE: should be zombienet-arc-runner (without quotes)
    timeout-minutes: 60
    container:
      image: ${{ needs.preflight.outputs.ZOMBIENET_IMAGE }}
    env:
      RELAY_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/polkadot-debug:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
      COL_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/test-parachain:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: script
        run: |
          echo "RELAY_IMAGE: $RELAY_IMAGE"
          echo "COL_IMAGE: $COL_IMAGE"
          export DEBUG=${{ needs.preflight.outputs.DEBUG }}
          /home/nonroot/zombie-net/scripts/ci/run-test-local-env-manager.sh \
            --local-dir="$(pwd)/$LOCAL_DIR" \
            --concurrency=1 \
            --test="0008-elastic_authoring.zndsl"

      - name: upload logs
        uses: actions/upload-artifact@v4
        with:
          name: zombienet-logs-${{ github.job }}-${{ github.sha }}
          path: |
            /tmp/zombie*/logs/*

  zombienet-cumulus-0009-elastic_pov_recovery:
    needs: [preflight]
    if: ${{ needs.preflight.outputs.changes_substrate || needs.preflight.outputs.changes_cumulus || needs.preflight.outputs.changes_polkadot }}
    runs-on: ${{ needs.preflight.outputs.ZOMBIENET_RUNNER }} # NOTE: should be zombienet-arc-runner (without quotes)
    timeout-minutes: 60
    container:
      image: ${{ needs.preflight.outputs.ZOMBIENET_IMAGE }}
    env:
      RELAY_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/polkadot-debug:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
      COL_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/test-parachain:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: script
        run: |
          echo "RELAY_IMAGE: $RELAY_IMAGE"
          echo "COL_IMAGE: $COL_IMAGE"
          export DEBUG=${{ needs.preflight.outputs.DEBUG }}
          /home/nonroot/zombie-net/scripts/ci/run-test-local-env-manager.sh \
            --local-dir="$(pwd)/$LOCAL_DIR" \
            --concurrency=1 \
            --test="0009-elastic_pov_recovery.zndsl"

      - name: upload logs
        uses: actions/upload-artifact@v4
        with:
          name: zombienet-logs-${{ github.job }}-${{ github.sha }}
          path: |
            /tmp/zombie*/logs/*

  zombienet-cumulus-0010-elastic_scaling_multiple_block_per_slot:
    needs: [preflight]
    if: ${{ needs.preflight.outputs.changes_substrate || needs.preflight.outputs.changes_cumulus || needs.preflight.outputs.changes_polkadot }}
    runs-on: ${{ needs.preflight.outputs.ZOMBIENET_RUNNER }} # NOTE: should be zombienet-arc-runner (without quotes)
    timeout-minutes: 60
    container:
      image: ${{ needs.preflight.outputs.ZOMBIENET_IMAGE }}
    env:
      # sdk tests are looking for POLKADOT_IMAGE
      POLKADOT_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/polkadot-debug:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
      CUMULUS_IMAGE: "${{ needs.preflight.outputs.TEMP_IMAGES_BASE }}/test-parachain:${{ needs.preflight.outputs.DOCKER_IMAGES_VERSION }}"
      RUST_LOG: ${{ needs.preflight.outputs.RUST_LOG }}
      ZOMBIE_PROVIDER: ${{ needs.preflight.outputs.ZOMBIE_PROVIDER }}
      # don't retry sdk tests
      NEXTEST_RETRIES: 0

    steps:
      - name: k8s_auth
        shell: bash
        run: |
          . /home/nonroot/zombie-net/scripts/ci/run-test-local-env-manager.sh
          k8s_auth

      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/download-artifact@v4.1.8
        with:
          name: prepare-cumulus-zombienet-artifacts-${{ needs.preflight.outputs.SOURCE_REF_SLUG }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ needs.preflight.outputs.BUILD_RUN_ID }}

      - name: tar
        run: tar -xvf artifacts.tar

      - name: script
        run: |
          echo "POLKADOT_IMAGE: $POLKADOT_IMAGE"
          echo "CUMULUS_IMAGE: $CUMULUS_IMAGE"
          ls -ltr ./artifacts
          # use spot by default
          export X_INFRA_INSTANCE=spot
          # we want to use `--no-capture` in zombienet tests.
          unset NEXTEST_FAILURE_OUTPUT
          unset NEXTEST_SUCCESS_OUTPUT
          cargo nextest run --archive-file ./artifacts/cumulus-zombienet-tests.tar.zst --no-capture -- elastic_scaling::elastic_scaling_multiple_blocks_per_slot::elastic_scaling_multiple_block_per_slot

      - name: upload logs
        uses: actions/upload-artifact@v4
        with:
          name: zombienet-logs-${{ github.job }}-${{ github.sha }}
          path: |
            /tmp/zombie*/logs/*
