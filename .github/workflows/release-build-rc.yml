name: Release - Build node release candidate

on:
  workflow_dispatch:
    inputs:
      binary:
        description: Binary to be build for the release
        default: all
        type: choice
        options:
          - polkadot
          - polkadot-parachain
          - all

      release_tag:
        description: Tag matching the actual release candidate with the format stableYYMM-rcX or stableYYMM
        type: string

jobs:
  # TODO: Activate this job when the pipeline is moved to the fork in the `paritytech-release` org
  # check-workflow-can-run:
  #   uses: paritytech-release/sync-workflows/.github/workflows/check-syncronization.yml@latest

  build-polkadot-binary:
    # needs: [check-workflow-can-run]
    if: ${{ inputs.binary == 'polkadot' || inputs.binary == 'all' }}
    uses: "./.github/workflows/release-reusable-rc-buid.yml"
    with:
      binary: '["polkadot", "polkadot-prepare-worker", "polkadot-execute-worker"]'
      package: polkadot
      release_tag: ${{ inputs.release_tag }}
    secrets:
      PGP_KMS_KEY:  ${{ secrets.PGP_KMS_KEY }}
      PGP_KMS_HASH:  ${{ secrets.PGP_KMS_HASH }}
      AWS_ACCESS_KEY_ID:  ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION:  ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_RELEASE_ACCESS_KEY_ID: ${{ secrets.AWS_RELEASE_ACCESS_KEY_ID }}
      AWS_RELEASE_SECRET_ACCESS_KEY: ${{ secrets.AWS_RELEASE_SECRET_ACCESS_KEY }}

  build-polkadot-parachain-binary:
    # needs: [check-workflow-can-run]
    if: ${{ inputs.binary == 'polkadot-parachain' || inputs.binary == 'all' }}
    uses: "./.github/workflows/release-reusable-rc-buid.yml"
    with:
      binary: '["polkadot-parachain"]'
      package: "polkadot-parachain-bin"
      release_tag: ${{ inputs.release_tag }}
    secrets:
      PGP_KMS_KEY:  ${{ secrets.PGP_KMS_KEY }}
      PGP_KMS_HASH:  ${{ secrets.PGP_KMS_HASH }}
      AWS_ACCESS_KEY_ID:  ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION:  ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_RELEASE_ACCESS_KEY_ID: ${{ secrets.AWS_RELEASE_ACCESS_KEY_ID }}
      AWS_RELEASE_SECRET_ACCESS_KEY: ${{ secrets.AWS_RELEASE_SECRET_ACCESS_KEY }}

# - name: Upload artifacts to github release
