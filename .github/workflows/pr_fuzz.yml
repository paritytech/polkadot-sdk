name: Checkout Fuzzer Repo

on:
    # push:
    # pull_request:

jobs:
  checkout:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Fuzzer Repo
      uses: actions/checkout@v2
      with:
        repository: 'srlabs/substrate-runtime-fuzzer'
        path: 'runtime_fuzzer'

    - name: Get PR Details 
      run: |
          # TODO: (hardcoded for demo, pedning to push PR)
          # This is a placeholder to find affected pallet in the PR and post the coverage report

    - name: Install Rust target
      run: rustup target add wasm32-unknown-unknown

    - name: Install dependencies
      run: cargo install ziggy cargo-afl honggfuzz grcov

    - name: Fuzz only Treasury pallet for Demo
      run: |
        # TODO: There are some pallet dependecies within the template, we cant remove all pallet
        # Ref: https://github.com/DcrHB/polkadot-sdk/actions/runs/16742477104/job/47393516245
        # cd runtime_fuzzer/templates/kitchensink/
        # cp Cargo.toml Cargo.toml.bak
        # sed -i '/^pallet-/ s/^/#/' Cargo.toml
        # sed -i '/#pallet-treasury/ s/^#//' Cargo.toml
        # sed -i '/#pallet-timestamp/ s/^#//' Cargo.toml

    - name: Print Cargo.toml
      run: |
          cd runtime_fuzzer/templates/kitchensink/
          cat Cargo.toml

    - name: Run cargo ziggy fuzz for 15 minute
      run: |
        cd runtime_fuzzer/templates/kitchensink/
        ls -la
        export SKIP_WASM_BUILD=1
        # TODO: Fuzzer output not persisted in the output
        timeout 15m cargo ziggy fuzz &> fuzz.txt
        # tail -f ./output/kitchensink-fuzzer/logs/afl.log

    - name: Upload Fuzzer Output
      uses: actions/upload-artifact@v4
      with:
          name: fuzzer-output
          path: runtime_fuzzer/templates/kitchensink/fuzz.txt

    - name: Get Coverage 
      run: |
        # TODO: 
        # This is a placeholder to get gcov report

    - name: Post the coverage report in PR
      run: |
        # TODO: 
        # This is a placeholder to post the coverage report in PR

    - name: Send message to Element chat
      run: |
        # TODO: 
        # (Optional) This is a placeholder to send a message to Element chat
        echo "Sending message to Element chat..."



