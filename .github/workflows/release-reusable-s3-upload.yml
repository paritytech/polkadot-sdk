name: Upload to s3

on:
  workflow_call:
    inputs:
      package:
        description: Package to be built, for now is either polkadot or polkadot-parachain-bin
        required: true
        type: string

      release_tag:
        description: Tag matching the actual release candidate with the format stableYYMM-rcX or stableYYMM-rcX
        required: true
        type: string

      target:
        description: Target triple for which the artifacts are being uploaded (e.g aarch64-apple-darwin)
        required: true
        type: string

    secrets:
      AWS_DEFAULT_REGION:
        required: true
      AWS_RELEASE_ACCESS_KEY_ID:
        required: true
      AWS_RELEASE_SECRET_ACCESS_KEY:
        required: true

jobs:
  upload-artifacts-to-s3:
      runs-on: ubuntu-latest
      environment: release
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_RELEASE_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_RELEASE_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

      steps:
        - name: Checkout
          uses: actions/checkout@d632683dd7b4114ad314bca15554477dd762a938 # v4.2.0

        - name: Download amd64 artifacts
          if: ${{ inputs.target == 'x86_64-unknown-linux-gnu' }}
          uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
          with:
            name: ${{ inputs.package }}
            path: artifacts/${{ inputs.package }}

        - name: Download arm artifacts
          if: ${{ inputs.target == 'aarch64-apple-darwin' }}
          uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
          with:
            name: ${{ inputs.package }}_aarch64-apple-darwin
            path: artifacts/${{ inputs.package }}

        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
          with:
            aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}

        - name: Upload ${{ inputs.package }} artifacts to s3
          run: |
            . ./.github/scripts/release/release_lib.sh
            upload_s3_release ${{ inputs.package }} ${{ inputs.release_tag }} ${{ inputs.target }}
